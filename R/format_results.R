get_cell_counts <- function(one_stratum, cell_nodes){
  if(length(cell_nodes)>0){
    cell_data <- one_stratum[,cell_nodes, with = FALSE]
    cells <- do.call(CJ, lapply(cell_data, unique))
    count_dt <- setkey(cell_data)[cells, list(n_cell=.N), by=.EACHI]
    count_dt[,n:=sum(n_cell)]
  } else{
    count_dt <- data.table(n=nrow(one_stratum))
  }

  return(count_dt)
}

#' @export
get_obs_counts <- function(data, nodes, tl_params){
  count_nodes <- c(nodes$strata)

  #get nodes that define the "cells" for each strata
  cell_nodes <- c()
  if(tl_params$count_A) { cell_nodes <- c(cell_nodes,nodes$A)}
  if(tl_params$count_Y) { cell_nodes <- c(cell_nodes,nodes$Y)}

  # count cells in each strata
  counts <- data[,get_cell_counts(.SD, cell_nodes), by=eval(nodes$strata)]

  counts <- counts[n!=0]
  return(counts)
}

#' Extract intervention levels from parameter names
#' @importFrom stringr str_match_all
#' @importFrom data.table as.data.table
get_intervention_levels <- function(param_names){
  matches <- str_extract_all(param_names, "A=([^\\}]*)",simplify="TRUE")
  matches <- gsub("A=","",matches)
  matches[matches==""]=NA
  matches <- as.data.table(matches)
  setnames(matches, c("intervention", "baseline"))

  return(matches)
}

#' @export
format_results <- function(results, data, nodes){
  # extract intervention levels
  intervention_levels <- get_intervention_levels(results$param)
  set(results, , names(intervention_levels), intervention_levels)

  # get nodes
  node_data <- as.data.table(lapply(nodes[c("W","A","Y")],paste,collapse=", "))
  if(is.null(node_data$W)){
    node_data$W="unadjusted"
  }

  set(results, , names(node_data), node_data)

  # pull out useful columns
  keep_cols <- c(nodes$strata, "W", "A", "Y",
                 "type", "param",
                 "intervention", "baseline",
                 "psi_transformed", "lower_transformed", "upper_transformed",
                 "tmle_est","se")
  nice_names <- c(nodes$strata, "adjustment_set", "intervention_variable", "outcome_variable",
                "type", "parameter",
                "intervention_level","baseline_level",
                "estimate","ci_lower","ci_upper",
                "untransformed_estimate","untransformed_se")
  formatted <- results[,keep_cols, with=FALSE]
  setnames(formatted, nice_names)

  # add collapsed strata label for plotting
  strata_map <- collapse_strata(data, nodes)
  formatted <- merge(strata_map,formatted, by=nodes$strata)

  return(formatted)
}
